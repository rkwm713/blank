# README: Make-Ready Excel Report - Structure and Data Mapping

**Last Updated:** May 15, 2025

**Source JSON Guides:**
* Developer's Guide to Katapult JSON Structure with Examples (`Developer's Guide to Katapult JSON Structure with Examples.md`)
* Developer's Guide to SPIDAcalc JSON Structure with Examples (`Developer's Guide to SPIDAcalc JSON Structure with Examples.md`)

**Excel Structure Reference:** `excel_example.png`

## 1. Introduction

This document details the structure of the generated Make-Ready Excel report. It explains how data from the input Katapult and SPIDAcalc JSON files is mapped to specific columns and cells in the report. This guide is intended for users interpreting the report and for developers maintaining or extending the report generation logic.

The report is designed to provide a comprehensive overview of existing conditions, proposed make-ready work, and relevant engineering data for each utility pole and its attachments.

## 2. Report Structure Overview

The Excel report typically consists of one main sheet (e.g., "Make Ready Report"). Each pole processed will have one or more rows:
* A primary set of rows for general pole information and mid-span data (often merged across multiple attachment rows).
* Subsequent rows detailing each individual attachment on that pole, including its existing and proposed heights.

Data is presented in columns, as detailed below.

## 3. Column-by-Column Data Mapping

The following explains the source and logic for each column in the "Make Ready Report" sheet, referencing the column letters from `image.png`.

---

**Column A: Operation Number**
* **Description:** A sequential number for each line item or pole operation.
* **Source Logic:** Typically an auto-incrementing counter for each pole or major block of information.
* **JSON Source:** N/A (Generated by the reporting script).

---

**Column B: Attachment Action**
* **Description:** Indicates the action for the pole or specific attachments. Examples: `(I)nstalling`, `(R)emoving`, `(E)xisting`. This column often reflects the overall status for a pole or a specific summary line. Individual attachment actions (new, modified, removed, existing) are determined by comparing SPIDA Measured vs. Recommended designs, and Katapult data.
* **Source Logic:**
    * Determined by comparing the set of attachments and their heights in SPIDAcalc's "Measured Design" vs. "Recommended Design."
    * If SPIDAcalc data is not available, all attachments from Katapult are considered `(E)xisting`.
    * If an attachment is in SPIDA Recommended but not Measured -> `(I)nstalling` related.
    * If an attachment is in SPIDA Measured but not Recommended -> `(R)emoving` related.
    * If an attachment is in both and height changes -> `(E)xisting` (with modification implied by height change).
    * If an attachment is in both and no change -> `(E)xisting`.
* **JSON Source:**
    * **SPIDAcalc:** `locations[loc_idx].designs` (compare "Measured Design" vs. "Recommended Design" `structure.wires` and `structure.equipments`).
    * **Katapult:** `nodes[node_id].attributes.kat_work_type.button_added` or `work_type.button_added` might provide overall pole work context.

---

**Column C: Pole Owner**
* **Description:** The owner of the utility pole.
* **Source Logic:** Prioritize Katapult data if available; fallback to SPIDAcalc if necessary and consistent.
* **JSON Source:**
    * **Katapult (Primary):** `nodes[NODE_ID].attributes.PoleOwner.assessment`
        * *Snippet (Katapult - Snippet B):* `"PoleOwner": { "assessment": "CPS Energy" }`
    * **SPIDAcalc (Fallback/Reference):** The owner of the pole itself isn't explicitly stated as an attribute in the same way, but the primary utility attachments often indicate this (e.g., `designs[design_idx].structure.wires[wire_idx].owner.id` for utility-owned wires). This column is usually the pole structure owner.

---

**Column D: Pole #**
* **Description:** The unique identifier for the pole.
* **Source Logic:** Use the normalized pole identifier. Prioritize Katapult's primary identifier.
* **JSON Source:**
    * **Katapult (Primary):** `nodes[NODE_ID].attributes.PoleNumber['-Imported']` or `nodes[NODE_ID].attributes.PoleNumber['assessment']`. Normalize using `processor.utils.normalize_pole_id()`.
        * *Snippet (Katapult - Snippet B):* `"PoleNumber": { "-Imported": "PL370858" }`
    * **SPIDAcalc (Matching Key):** `locations[loc_idx].label`. Normalize this to match.
        * *Snippet (SPIDAcalc - Snippet B):* `"label": "1-PL410620"`

---

**Column E: Pole Structure**
* **Description:** Physical characteristics of the pole (e.g., "40-4 Southern Pine").
* **Source Logic:** Combine pole height, class, and species. Prioritize Katapult data as it's field-verified.
* **JSON Source:**
    * **Katapult (Primary):**
        * Height: `nodes[NODE_ID].attributes.PoleHeight.assessment`
        * Class: `nodes[NODE_ID].attributes.PoleClass.assessment`
        * Species: `nodes[NODE_ID].attributes.PoleSpecies.assessment`
        * *Snippet (Katapult - Snippet B):* `"PoleHeight": { "assessment": "40" }, "PoleClass": { "assessment": "3" }, "PoleSpecies": { "assessment": "Southern Pine" }`
    * **SPIDAcalc (Reference/Engineering View):**
        * Height: `designs[design_idx].structure.pole.clientItem.height.value` (convert from METERS)
        * Class: `designs[design_idx].structure.pole.clientItem.classOfPole`
        * Species: `designs[design_idx].structure.pole.clientItem.species`
        * *Snippet (SPIDAcalc - Snippet D):* `"height": {"unit": "METRE", "value": 12.192...}, "classOfPole": "3", "species": "Southern Pine"`

---

**Column F: Proposed Riser (Yes/No)**
* **Description:** Indicates if a new or modified riser is proposed for this pole.
* **Source Logic:** This typically comes from specific make-ready instructions or analysis in SPIDAcalc. Check for equipment/wires tagged as "Riser" in the "Recommended Design" that are new or modified. If not explicitly in JSON, this might be a manual input or derived from notes.
* **JSON Source:**
    * **SPIDAcalc:** Look for `equipments` or `wires` in `Recommended Design` where `clientItem.type` or `clientItem.description` indicates "Riser" and compare against "Measured Design."
    * **Katapult:** Less likely to have "proposed" data unless specific attributes are used to flag this.

---

**Column G: Proposed Guy (Yes/No)**
* **Description:** Indicates if a new or modified guy wire is proposed.
* **Source Logic:** Similar to "Proposed Riser." Check for wires with `usageGroup: "GUY"` or description indicating "Guy" in SPIDAcalc's "Recommended Design" that are new or modified.
* **JSON Source:**
    * **SPIDAcalc:** `designs[design_idx].structure.wires` where `usageGroup == "GUY"` or `clientItem.description` contains "Guy". Compare "Measured" vs. "Recommended".
        * *Snippet (SPIDAcalc - Snippet E, conceptual for guy):* `{"usageGroup": "GUY", "clientItem": {"description": "1/4 EHS Guy Wire"}}`
    * **Katapult:** Unlikely to have proposed guy information.

---

**Column H: PLA (%) with proposed attachment**
* **Description:** Pole Loading Analysis percentage, considering proposed attachments.
* **Source Logic:** This value should ideally come from SPIDAcalc's analysis of the "Recommended Design." If SPIDAcalc is not used or doesn't provide this, Katapult's `final_passing_capacity_%` might be used as a proxy or existing state.
* **JSON Source:**
    * **SPIDAcalc (Primary for Proposed):** `locations[loc_idx].poleResults` array. Find the entry corresponding to the "Recommended Design" and overall pole stress.
        * *Snippet (SPIDAcalc - Snippet G):* `{"component": "Pole", "analysisType": "STRESS", "actual": 42.55, "designLabel": "Recommended Design"}` (look for this pattern)
    * **Katapult (Fallback/Existing):** `nodes[NODE_ID].attributes.final_passing_capacity_%` (extract nested value).
        * *Snippet (Katapult - Snippet B):* `"final_passing_capacity_%": {"-ONzZigRJczUNfA6wSoG": "41.95"}`

---

**Column I: Construction Grade of Analysis**
* **Description:** The construction grade used for the analysis (e.g., B, C).
* **Source Logic:** Prioritize SPIDAcalc if it specifies grade per analysis. Fallback to Katapult.
* **JSON Source:**
    * **SPIDAcalc (Primary):** `locations[loc_idx].poleResults[result_idx].loadInfo` (e.g., "Light - Grade C"). Extract the grade.
        * *Snippet (SPIDAcalc - Snippet G):* `"loadInfo": "Light - Grade C"`
    * **Katapult (Fallback):** `nodes[NODE_ID].attributes.construction_grade_analysis.assessment`
        * *Snippet (Katapult - Snippet B):* `"construction_grade_analysis": { "assessment": "B" }`

---

**Columns J & K: Existing Mid-Span Data**

These columns display the lowest communication and electrical cable heights in the span *from* the current pole *to* an adjacent pole. The "From Pole" and "To Pole" boxes within these cells provide context for which span the data refers to.

* **Column J: Height Lowest Com**
* **Column K: Height Lowest CPS Electrical**

* **Source Logic (General):**
    1.  Identify connections originating from the current pole (`katapult_data.connections` where `node_id_1` or `node_id_2` matches the current pole).
    2.  For each connected span (to an adjacent pole), analyze its sections.
    3.  Within `connection_data.sections[section_id].photos` (if available), look at `photofirst_data.wire` annotations.
    4.  Use the `_trace` ID to link to `katapult_data.traces.trace_data` to determine `company` and `cable_type`.
    5.  **For Lowest Com:** Find the minimum `_measured_height` (convert from INCHES) of wires where `cable_type` indicates communication (e.g., "Telco Com", "CATV Com", "Fiber Optic Com") across all sections of that specific span.
    6.  **For Lowest CPS Electrical:** Find the minimum `_measured_height` (convert from INCHES) of wires where `company` is "CPS Energy" (or the defined electrical utility) and `cable_type` is electrical (e.g., "Primary", "Secondary", "Neutral" - often "Primary" or "Secondary" are of most interest for clearance, but "Neutral" might be lowest electrical) across all sections of that specific span.
    7.  If a span is marked as underground (`connection_data.button == "underground_path"` or similar attribute), these heights should be "UG" or "N/A".
    8.  If no measurable attachments of the type are found, display "NA".

* **"From Pole" / "To Pole" Boxes (within J & K):**
    * **Purpose:** To clearly indicate which span the mid-span heights refer to, especially when a pole has multiple connections.
    * **"From Pole PLXXXXXX":** This will always be the current `Pole #` from Column D.
    * **"To Pole PLYYYYYY":** This is the `Pole #` (normalized ID from Katapult) of the adjacent pole for the specific span whose data is being shown.
        * **JSON Source (Katapult):**
            * Current Pole ID: `NODE_ID`
            * Connection: `katapult_data.connections[CONNECTION_ID]`
            * Adjacent Pole ID: If `node_id_1 == NODE_ID`, then `node_id_2` is adjacent. Else, `node_id_1` is adjacent.
            * Adjacent Pole's Display #: Look up this adjacent `node_id` in `katapult_data.nodes` and get its `PoleNumber` attribute (normalized).
            * *Snippet (Katapult - Snippet F):* `"node_id_1": "-OJ_PU-d5b_qyvPLb1ox", "node_id_2": "-OJ_PMjpiNrD4UyT0JSz"`

* **"Red (North East) to service pole" / "Red (North East to PL#####)" Special Boxes:**
    * **Purpose:** These appear to indicate a specific type of connection, likely a service drop or a tap line, possibly color-coded or directionally noted in the field data or design. The "Red" and direction ("North East") are descriptive.
    * **When to use:** This requires specific tagging or attributes in your Katapult or SPIDAcalc data that are not standard in the base JSON structures shown so far.
        * **Katapult:** You might have a custom attribute in `connections[CONNECTION_ID].attributes` like `"service_drop_info": {"color": "Red", "direction": "NE", "to_service_location": true}` or `user_description` on a trace.
        * **SPIDAcalc:** Notes or specific client item descriptions for wires in a span might indicate this.
    * **Data for "To service pole" or "To PL#####":**
        * If it's a generic service pole without a specific ID in the system, it might just say "service pole."
        * If it connects to another numbered pole (PL#####), that number would be derived as per the regular "To Pole" logic.
    * **Why tricky (Columns J-O):** These columns require integrating data *about* a span with data *on* a pole. The "Red..." boxes imply a specific span is being highlighted, and its mid-span data (J, K) and potentially proposed changes (O) would relate to that specific span.

---

**Columns L, M, N: Make Ready Data (per attachment)**

These columns are repeated for each attachment on the pole.

* **Column L: Attacher Description**
    * **Description:** The name of the company owning the attachment and its type.
    * **Source Logic:** Consolidate attacher name and description type.
        * **Attacher Name:** Prioritize Katapult `traces.trace_data.company`. If SPIDAcalc is primary for an attachment, use `owner.id`. Normalize names (e.g., "AT&T" vs "ATT") using `processor.constants.py`.
        * **Description Type:** Prioritize Katapult `traces.trace_data.cable_type`. If SPIDAcalc is primary, use `clientItem.description` or `clientItem.type`.
    * **Display Format:** Typically "CompanyName CableType" (e.g., "AT&T Fiber Optic Com", "CPS Energy Neutral").
    * **JSON Source:**
        * **Katapult:** `traces.trace_data[TRACE_ID].company` and `traces.trace_data[TRACE_ID].cable_type`.
            * *Snippet (Katapult - Snippet D):* `"company": "CPS Energy", "cable_type": "Primary"`
        * **SPIDAcalc:** `owner.id` and `clientItem.description` / `clientItem.size` / `clientItem.type`.
            * *Snippet (SPIDAcalc - Snippet E):* `"owner": {"id": "CPS Energy"}, "clientItem": {"description": "336.4 ACSR - Merlin"}`
            * *Snippet (SPIDAcalc - Snippet F):* `"owner": {"id": "CPS Energy"}, "clientItem": {"type": "TRANSFORMER", "size": "25 kVA Single Phase"}`

* **Column M: Attachment Height - Existing**
    * **Description:** The existing measured height of the attachment.
    * **Source Logic:**
        1.  **Katapult (Primary):** `_measured_height` from photo wire/equipment annotations (convert from INCHES).
        2.  **SPIDAcalc "Measured Design" (Secondary/Verification):** `attachmentHeight.value` (convert from METERS).
        3.  Apply conflict resolution strategy if both exist and differ. Katapult is generally preferred for existing field-verified heights.
    * **JSON Source:**
        * **Katapult:** `nodes[...].photos[...].photofirst_data.wire[...]._measured_height`
            * *Snippet (Katapult - Snippet C):* `"_measured_height": "355.5"` (INCHES)
        * **SPIDAcalc:** `designs[label="Measured Design"].structure.wires/equipments[...].attachmentHeight.value`
            * *Snippet (SPIDAcalc - Snippet E):* `"attachmentHeight": {"unit": "METRE", "value": 11.2268}` (METERS)

* **Column N: Attachment Height - Proposed**
    * **Description:** The proposed height of the attachment after make-ready work.
    * **When to Enter a Height:** A height should be entered here if:
        1.  A new attachment is being installed (its proposed height).
        2.  An existing attachment is being moved (its new proposed height).
        3.  If an existing attachment is *not* moving and SPIDAcalc data is present, this column would show the same height as Column M (its existing height, confirmed in the "Recommended Design").
        4.  If an existing attachment is *not* moving and only Katapult data is present, this column typically shows the same as Column M.
        5.  If an attachment is being removed, this column is typically blank or "N/A".
    * **Source Logic:**
        1.  **SPIDAcalc "Recommended Design" (Primary):** `attachmentHeight.value` (convert from METERS). This is the authoritative source for proposed heights.
        2.  If an attachment from "Measured Design" or Katapult is *not* present in "Recommended Design," it's likely removed (Column N blank).
        3.  If SPIDAcalc data is not available, proposed height is generally assumed to be the same as existing height (from Katapult).
    * **JSON Source:**
        * **SPIDAcalc:** `designs[label="Recommended Design"].structure.wires/equipments[...].attachmentHeight.value`

---

**Column O: Mid-Span (same span as existing)**
* **Description:** This column seems to represent the proposed status or a key characteristic of the mid-span *after* make-ready, or a note about an existing critical mid-span condition related to the "From Pole / To Pole" context. The title "some name on existing" is ambiguous in the image. It could be:
    * Proposed lowest communication height in the span.
    * Proposed lowest electrical height in the span.
    * A status like "UG" (Underground) if the span is proposed to be or is underground.
    * A clearance value related to a specific proposed attachment in that span.
* **Source Logic (Highly Dependant on Precise Definition):**
    * If it's about **proposed mid-span heights**: SPIDAcalc might have analysis results for spans in its "Recommended Design," or this would be calculated based on proposed attachment heights at both ends of the span and sag/catenary calculations (which are complex and usually done by SPIDAcalc itself, not easily derived from basic JSON output unless specific mid-span clearance results are exported).
    * If it's about **underground status**:
        * **Katapult:** `connections[CONNECTION_ID].button == "underground_path"` or similar attribute.
        * **SPIDAcalc:** The span/connection itself might be modeled differently or have notes in the "Recommended Design."
    * If it's a specific **existing critical clearance** not covered by J/K, its source would be Katapult mid-span measurements (Rule K23).
* **JSON Source:** This is speculative without a clearer definition of the column's intent.
    * **SPIDAcalc:** Check `designs[label="Recommended Design"]` for any span-related analysis or wire properties that indicate a change or specific proposed state for mid-span clearances.
    * **Katapult:** For existing conditions or UG status as noted above.

---

## 4. Handling Different Attachers

* **Consolidation:** Attacher names from Katapult (`traces.trace_data.company`) and SPIDAcalc (`owner.id`) should be normalized. For example, "AT&T", "ATT", "AT&T Communications" should all map to a standard name like "AT&T". This mapping should be managed in `processor.constants.py`.
* **Display:** In Column L, display the normalized attacher name followed by a concise description of the attachment type (e.g., "AT&T Fiber Optic", "CPS Energy Secondary", "Spectrum Coax").
* **Order:** Attachments are typically listed per pole, often grouped by owner or by height (e.g., top-down). The generation script defines this order. Electrical utilities (like "CPS Energy") are often listed first, followed by communication attachers.

## 5. General Notes

* **Units:** All height data from Katapult (`_measured_height`) is typically in **INCHES**. All height data from SPIDAcalc (`attachmentHeight.value`) is typically in **METERS**. These **MUST** be converted to a consistent reporting unit (e.g., feet with 1 or 2 decimal places) using `processor.height_utils.py`.
* **Missing Data:** If data for a specific cell is not available in the JSONs, it should be represented as "N/A", blank, or a pre-defined placeholder.
* **Conflict Resolution:** When data for the same field (e.g., existing attachment height) is available from both Katapult and SPIDAcalc, a defined conflict resolution strategy (e.g., "Prefer Katapult for existing field data") must be applied.

---

## 6. Conclusion

This README provides a comprehensive reference for understanding how the Make-Ready Excel report is structured and populated from Katapult and SPIDAcalc data. It should serve as a source of truth for debugging, extending, or auditing the report generation logic.

If the report layout changes or if Katapult/SPIDAcalc schemas are updated, this document should be revised accordingly.

